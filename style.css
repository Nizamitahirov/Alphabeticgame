document.addEventListener('DOMContentLoaded', () => {
    // --- GENİŞ SUALLAR BAZASI (ƏN AZI 25 SUAL ƏLAVƏ EDİN Kİ, OYUN BAŞLASIN) ---
    // Real tətbiqdə bura 300 sual və hər biri üçün "example_ideas" əlavə edin.
    const allQuestionsPool = [
        // Ev Əşyaları
        { category: "Ev Əşyaları", question: "Qonaq otağında olan bir mebel.", example_ideas: ["divan", "kreslo", "stol", "televizor altlığı", "kitab rəfi", "pərdə", "xalça"] },
        { category: "Ev Əşyaları", question: "Yataq otağında istifadə edilən bir şey.", example_ideas: ["yataq", "dolab", "güzgü", "gecə lampası", "yastıq", "ədyal", "komod"] },
        { category: "Ev Əşyaları", question: "Hamam otağında olan bir ləvazimat.", example_ideas: ["sabun", "şampun", "dəsmal", "diş fırçası", "fen", "lif", "tarak"] },
        { category: "Ev Əşyaları", question: "Təmizlik üçün istifadə edilən vasitə.", example_ideas: ["süpürgə", "tozsoran", "bez", "maye sabun", "fırça", "vedrə", "əlcək"] },
        { category: "Ev Əşyaları", question: "Mətbəxdə yemək bişirmək üçün alət.", example_ideas: ["qazan", "tava", "bıçaq", "blender", "mikser", "süzgəc", "rende"] },
        { category: "Ev Əşyaları", question: "İşıqlandırma üçün istifadə olunan.", example_ideas: ["lampa", "çılçıraq", "bra", "projektor", "fənər", "spot"] },
        { category: "Ev Əşyaları", question: "Pəncərədə istifadə olunan bir şey.", example_ideas: ["pərdə", "jalüz", "şüşə", "pəncərəaltı", "tor", "dəstək"] },
        { category: "Ev Əşyaları", question: "Divardan asılan bir dekorasiya.", example_ideas: ["şəkil", "saat", "güzgü", "xalça (kiçik)", "pano", "çərçivə"] },
        { category: "Ev Əşyaları", question: "Yemək masasında olan bir şey.", example_ideas: ["boşqab", "stəkan", "qaşıq", "çəngəl", "salat qabı", "süfrə", "peçetka"] },
        { category: "Ev Əşyaları", question: "Ofisdə iş masasının üzərində olan.", example_ideas: ["kompüter", "qələmdan", "monitor", "klaviatura", "kağız"] },

        // Heyvanlar
        { category: "Heyvanlar", question: "Evdə saxlanıla bilən bir heyvan.", example_ideas: ["pişik", "it", "quş", "balıq", "hamster", "dovşan", "tısbağa"] },
        { category: "Heyvanlar", question: "Afrikada yaşayan bir vəhşi heyvan.", example_ideas: ["şir", "fil", "zürafə", "zebra", "kərgədan", "begemot", "leopard"] },
        { category: "Heyvanlar", question: "Uça bilən bir canlı.", example_ideas: ["quş", "yarasa", "kəpənək", "arı", "ağcaqanad", "göyərçin", "qartal"] },
        { category: "Heyvanlar", question: "Suda yaşayan bir məməli.", example_ideas: ["balina", "delfin", "suiti", "dəniz donuzu", "dəniz şiri", "kaşalot"] },
        { category: "Heyvanlar", question: "Sürünən bir heyvan.", example_ideas: ["ilan", "timsah", "kərtənkələ", "tısbağa", "buqələmun", "varan"] },
        { category: "Heyvanlar", question: "Meşədə yaşayan bir gəmirici.", example_ideas: ["sincab", "siçan (çöl)", "dələ", "kirpi (qismən)", "sur"] },
        { category: "Heyvanlar", question: "Qış yuxusuna gedən bir heyvan.", example_ideas: ["ayı", "porsuq", "yarasa (bəzi növləri)", "ilan (soyuq havada)", "kirpi"] },
        { category: "Heyvanlar", question: "Zəhərli bir həşərat.", example_ideas: ["arı (allergiyası olan üçün)", "eşşəkarısı", "əqrəb", "qaraqurd", "böve"] },
        { category: "Heyvanlar", question: "Çöldə yaşayan bir quş.", example_ideas: ["sərçə", "qarğa", "bildirçin", "kəklik", "turac", "qaranquş"] },
        { category: "Heyvanlar", question: "Süd verən bir kənd heyvanı.", example_ideas: ["inək", "qoyun", "keçi", "at (qismən)"] },

        // Peşələr
        { category: "Peşələr", question: "Sənət sahəsində bir peşə.", example_ideas: ["rəssam", "musiqiçi", "aktyor", "heykəltaraş", "dizayner", "yazıçı", "rejissor"] },
        { category: "Peşələr", question: "Elmlə məşğul olan bir insan.", example_ideas: ["alim", "fizik", "kimyaçı", "bioloq", "astronom", "arxeoloq", "geoloq"] },
        { category: "Peşələr", question: "Tikinti ilə bağlı bir iş.", example_ideas: ["memar", "inşaatçı", "mühəndis", "bənna", "suvaqçı", "dülgər"] },
        { category: "Peşələr", question: "İnsanların sağlamlığı ilə məşğul olan.", example_ideas: ["həkim", "tibb bacısı", "stomatoloq", "əczaçı", "fizioterapevt", "psixoloq"] },
        { category: "Peşələr", question: "Qanunla bağlı bir peşə.", example_ideas: ["vəkil", "hakim", "prokuror", "notarius", "hüquqşünas", "müstəntiq"] },
        { category: "Peşələr", question: "Təhsillə bağlı bir peşə.", example_ideas: ["müəllim", "professor", "tərbiyəçi", "direktor", "dekan"] },
        { category: "Peşələr", question: "Nəqliyyatla bağlı bir peşə.", example_ideas: ["sürücü", "pilot", "kapitan", "maşinist", "bələdçi"] },
        { category: "Peşələr", question: "İdmanla bağlı bir peşə.", example_ideas: ["məşqçi", "idmançı", "hakim (idman)", "komentator"] },
        { category: "Peşələr", question: "Kənd təsərrüfatı ilə bağlı iş.", example_ideas: ["fermer", "əkinçi", "bağban", "zoomühəndis", "aqronom"] },
        { category: "Peşələr", question: "Xidmət sahəsində bir peşə.", example_ideas: ["ofisiant", "barmen", "aşpaz", "satıcı", "kassir"] },
        // Daha çox sual əlavə edin... (MƏSƏLƏN, CƏMİ 50-100 SUAL İLƏ BAŞLAYIN)
    ];

    // HƏRFLƏ BAŞLAYAN SÖZLƏR ÜÇÜN GENİŞLƏNDİRİLMİŞ LÜĞƏT
    const sampleVocabulary = {
        A: ["alma", "armud", "avtobus", "ayı", "ana", "açıqca", "aş", "ad", "alim", "aktyor", "astronom", "araba", "arxeoloq", "asılqan", "ağac", "ağcaqanad", "ayran", "aşpaz", "aqronom", "Avropa", "Afrika", "Atlantik"],
        B: ["banan", "balıq", "bıçaq", "bina", "bağ", "böyük", "balaca", "boşqab", "basketbol", "bioloq", "bənna", "balina", "bazar", "balkon", "bra", "blender", "bez", "bildirçin", "buqələmun", "badambura", "begemot", "barmen", "bələdçi", "bitki"],
        C: ["canavar", "corab", "cib", "cəld", "cücə", "cümə", "cərrah", "ceyran", "cin", "cədvəl"],
        Ç: ["çay", "çanta", "çətir", "çiyələk", "çəkic", "çiçək", "çinar", "çərşənbə", "çoban", "çörək", "çəngəl", "çərçivə", "çılçıraq", "çöl", "çəmən"],
        D: ["dovşan", "dəftər", "dəniz", "dağ", "darvaza", "divan", "dolma", "dizayner", "delfin", "dəmir", "düşbərə", "dəsmal", "diş", "direktor", "dekan", "dülgər", "dəvəquşu"],
        E: ["ev", "eşşək", "elm", "elektrik", "ekran", "enerji", "effekt", "elan", "era", "etiraf"],
        Ə: ["ərik", "əlcək", "əsgər", "ədyal", "ətir", "əsas", "əczaçı", "əfsanə", "əyləncə", "əqrəb", "əkinçi", "əhali", "ərazi"],
        F: ["fincan", "fil", "fırça", "futbol", "fərqli", "Fransa", "fizik", "fen", "fiqur", "fontan", "fermer", "fizioterapevt", "fənər", "fakt"],
        G: ["gəmi", "günəş", "gül", "göz", "gecə", "göy", "gitara", "gilas", "geyim", "güzgü", "geoloq", "göyərçin", "gəmirici", "gəzinti"],
        Ğ: ["ğar (mağara)", "ğəmgin (kədərli)"], // Çox azdır, praktikada istifadə edilməyə bilər
        H: ["həkim", "heyva", "hava", "hörümçək", "hesab", "həndbol", "hokkey", "hamster", "hekayə", "hakim", "hüquqşünas", "heyvan", "hovuz"],
        X: ["xalça", "xiyar", "xəritə", "xoruz", "xəstə", "xizək", "xəbər", "xəmir", "xəzinə", "xarakter", "xidmət", "xurma"],
        I: ["ıspanaq", "ıslıq", "işıq", "isti", "ırmaq (çay)", "ılgım (miraj)"],
        İ: ["ilan", "iynə", "isti", "it", "iki", "insan", "iş", "internet", "İtaliya", "inşaatçı", "idman", "inək", "iqlim", "ixtira"],
        J: ["jurnal", "jilet", "jeton", "judo", "jaket", "jalüz", "jele"],
        K: ["kitab", "keçi", "küçə", "kreslo", "kartof", "körpü", "kompüter", "kaktus", "kəpənək", "qəhvə (Kofe)", "kəklik", "kapitan", "kassir", "klaviatura", "komod", "konfet"],
        Q: ["qarpız", "qələm", "qapı", "qar", "qayıq", "qaşıq", "qutu", "qırmızı", "qızıl", "qonaq", "qaymaq", "qazan", "qartal", "qaranquş", "qoyun", "qəzet", "qəsr"],
        L: ["limon", "lampa", "lələk", "layla", "lacivərd", "limonad", "lobya", "lüğət", "leopar", "lif", "laboratoriya"],
        M: ["maşın", "meymun", "maral", "mavi", "məktəb", "müəllim", "memar", "musiqi", "marka", "Mars", "mikser", "maye", "mühəndis", "məşqçi", "müstəntiq", "monitor"],
        N: ["nar", "nənə", "neft", "nöqtə", "nailiyyət", "Novruz", "notarius", "nağıl", "nərgiz", "nəqliyyat", "nəfəs", "nümunə"],
        O: ["odun", "otaq", "oyun", "orta", "obraz", "okean", "oksigen", "opera", "ofisiant", "obyekt", "od"],
        Ö: ["ördək", "ömür", "örtük", "ölkə", "özəl", "ölçü", "öküz", "öskürək", "öyrənmək"],
        P: ["palıd", "pişik", "paltar", "pəncərə", "pul", "polis", "Python", "plov", "piano", "paxlava", "pendir", "pilot", "prokuror", "professor", "psixoloq", "pərdə", "projektor", "peçetka"],
        R: ["radio", "rəng", "rəsm", "robot", "ruh", "roman", "rəssam", "reqbi", "Respublika", "rejissor", "rende", "raket"],
        S: ["saat", "soba", "su", "səhər", "sarı", "sincab", "sabun", "sakit", "Saturn", "skripka", "sıyıq", "stol", "stul", "stəkan", "sürücü", "satıcı", "süpürgə", "spot", "süzgəc"],
        Ş: ["şar", "şir", "şəkil", "şəhər", "şokolad", "şam", "şampun", "şəkərbura", "şərf", "şahmat", "şüşə", "şezlonq", "şorba"],
        T: ["top", "tülkü", "telefon", "təyyarə", "torpaq", "tar", "timsah", "tibb", "toster", "tarix", "tava", "tarak", "tərbiyəçi", "turac", "tısbağa", "televizor", "trapesiya"],
        U: ["ulduz", "un", "uzaq", "uca", "uşaq", "universitet", "uğur", "usta", "uniforma"],
        Ü: ["üzüm", "ürək", "üç", "üst", "ütgəc", "ümid", "üzgüçülük", "ünsiyyət", "ülgüc"],
        V: ["vaqon", "velosiped", "vaza", "vətən", "varlı", "vulkan", "vəkil", "vitamin", "Venera", "voleybol", "varan", "vedrə"],
        Y: ["yumurta", "yağış", "yarpaq", "yaşıl", "yol", "yataq", "yanğınsöndürən", "Yupiter", "yaxata", "yastıq", "yazıçı", "yarasa"],
        Z: ["zebra", "zəng", "zeytun", "zibil", "zaman", "zürafə", "zanbaq", "zərgərlik", "Zevs", "zoomühəndis", "zirvə", "zəlzələ"]
    };

    const AZERBAIJANI_ALPHABET = Object.keys(sampleVocabulary).filter(letter => sampleVocabulary[letter] && sampleVocabulary[letter].length > 0);
    const QUESTIONS_PER_PLAYER = 25;
    const DEFAULT_ANSWER_TIME_LIMIT = 10;
    const FEEDBACK_DISPLAY_TIME = 1500;
    const LEADERBOARD_KEY = 'harfSehrbaziLeaderboardV5'; // Versiyanı artırdım ki, köhnə data ilə qarışmasın

    let adminSetAnswerTimeLimit = DEFAULT_ANSWER_TIME_LIMIT;
    let currentPlayerName = '';
    let selectedLetter = '';
    let score = 0;
    let currentQuestion = null;
    let questionsAskedThisPlayerGame = 0;
    let feedbackTimeoutId = null;
    let answerTimerId = null;
    let timeLeftForAnswer = 0;

    let globallyUsedQuestions = new Set();
    let questionsForCurrentPlayer = [];

    const initialSetupArea = document.getElementById('initial-setup-area');
    const playerNameInput = document.getElementById('player-name-input');
    const timerSettingInput = document.getElementById('timer-setting-input');
    const startPlayerGameBtn = document.getElementById('start-player-game-btn');
    const currentPlayerNameDisplayLetter = document.getElementById('current-player-name-display-letter');
    const currentPlayerNameDisplayGame = document.getElementById('current-player-name-display-game');
    const letterSelectionArea = document.getElementById('letter-selection-area');
    const letterButtonsContainer = document.getElementById('letter-buttons');
    const gameArea = document.getElementById('game-area');
    const chosenLetterDisplay = document.getElementById('chosen-letter-display');
    const scoreDisplay = document.getElementById('score-display');
    const questionCountDisplay = document.getElementById('question-count-display');
    const totalQuestionsPerPlayerDisplay = document.getElementById('total-questions-per-player');
    const timerDisplay = document.getElementById('timer-display');
    const categoryDisplay = document.getElementById('category-display');
    const questionText = document.getElementById('question-text');
    const adminPanel = document.getElementById('admin-panel');
    const reminderLetterAdmin = document.getElementById('reminder-letter-admin');
    const toggleExamplesBtn = document.getElementById('toggle-examples-btn');
    const exampleAnswersArea = document.getElementById('example-answers-area');
    const exampleAnswersList = document.getElementById('example-answers-list');
    const exampleLetterPlaceholder = document.getElementById('example-letter-placeholder');
    const noExamplesMessage = document.getElementById('no-examples-message');
    const adminCorrectBtn = document.getElementById('admin-correct-btn');
    const adminIncorrectBtn = document.getElementById('admin-incorrect-btn');
    const adminEndPlayerGameBtn = document.getElementById('admin-end-player-game-btn');
    const feedbackMessageArea = document.getElementById('feedback-message-area');
    const feedbackMessage = document.getElementById('feedback-message');
    const playerGameOverArea = document.getElementById('player-game-over-area');
    const playerNameGameOver = document.getElementById('player-name-game-over');
    const finalPlayerScoreDisplay = document.getElementById('final-player-score');
    const nextPlayerBtn = document.getElementById('next-player-btn');
    const showLeaderboardBtn = document.getElementById('show-leaderboard-btn');
    const leaderboardArea = document.getElementById('leaderboard-area');
    const leaderboardTableBody = document.querySelector('#leaderboard-table tbody');
    const backToPlayerNameBtn = document.getElementById('back-to-player-name-btn');
    const clearLeaderboardBtn = document.getElementById('clear-leaderboard-btn');
    const copyrightYearSpan = document.getElementById('copyright-year');

    function initGameSetup() {
        totalQuestionsPerPlayerDisplay.textContent = QUESTIONS_PER_PLAYER;
        createLetterButtons();
        if (copyrightYearSpan) {
            copyrightYearSpan.textContent = new Date().getFullYear();
        }
        showScreen('initial-setup');
    }

    function showScreen(screenName) {
        initialSetupArea.classList.add('hidden');
        letterSelectionArea.classList.add('hidden');
        gameArea.classList.add('hidden');
        playerGameOverArea.classList.add('hidden');
        leaderboardArea.classList.add('hidden');

        const screenElement = document.getElementById(screenName + '-area');
        if (screenElement) {
            screenElement.classList.remove('hidden');
        }

        if (screenName === 'leaderboard') {
            displayLeaderboard();
        }
    }

    startPlayerGameBtn.addEventListener('click', () => {
        const name = playerNameInput.value.trim();
        const timerValue = parseInt(timerSettingInput.value, 10);

        if (!name) {
            alert("Zəhmət olmasa, oyunçu adını daxil edin.");
            return;
        }
        if (isNaN(timerValue) || timerValue < 3) {
            alert("Zəhmət olmasa, hər sual üçün düzgün vaxt daxil edin (minimum 3 saniyə).");
            return;
        }

        // Sual hovuzunun yoxlanılması
        if (allQuestionsPool.length < QUESTIONS_PER_PLAYER) {
            alert(`Oyun başlaya bilməz! Sual hovuzunda minimum ${QUESTIONS_PER_PLAYER} sual olmalıdır. Hazırda ${allQuestionsPool.length} sual var. Zəhmət olmasa, script.js faylına daha çox sual əlavə edin.`);
            return;
        }

        currentPlayerName = name;
        adminSetAnswerTimeLimit = timerValue;
        currentPlayerNameDisplayLetter.textContent = currentPlayerName;
        currentPlayerNameDisplayGame.textContent = currentPlayerName;
        
        const questionsPrepared = prepareQuestionsForCurrentPlayer();
        if (questionsPrepared) {
            showScreen('letter-selection');
        }
        // prepareQuestionsForCurrentPlayer içində xəta olsa, özü alert verib geri qayıdacaq
    });

    function prepareQuestionsForCurrentPlayer() {
        questionsForCurrentPlayer = [];

        // Ümumi sual hovuzunda kifayət qədər sual olub olmadığını yoxlayaq
        if (allQuestionsPool.length < QUESTIONS_PER_PLAYER) {
            // Bu yoxlama artıq startPlayerGameBtn içində edilir, amma burada da saxlamaq zərər verməz.
            console.error("Kritik xəta: `allQuestionsPool`da kifayət qədər sual yoxdur.");
            return false;
        }

        let availableForSelection = shuffleArray([...allQuestionsPool]);
        let selectedCount = 0;
        let attempts = 0; // Sonsuz dövrün qarşısını almaq üçün
        const maxAttempts = allQuestionsPool.length * 2; // Təxmini bir limit

        while (selectedCount < QUESTIONS_PER_PLAYER && attempts < maxAttempts) {
            if (availableForSelection.length === 0) {
                // Əgər qlobal olaraq istifadə edilməmiş sual qalmayıbsa,
                // o zaman qlobal istifadə edilmişlər arasından seçməyə başlayaq
                // (amma bu oyunçu üçün təkrarlanmasın)
                console.warn("Qlobal unikal suallar bitdi, təkrarlanan suallar seçilə bilər (fərqli oyunçular üçün).");
                availableForSelection = shuffleArray([...allQuestionsPool]); // Bütün hovuzu yenidən götür
                if (availableForSelection.length === 0) break; // Əgər hovuz boşdursa, çıx
            }

            let questionCandidate = availableForSelection.pop();

            // Bu oyunçu üçün bu sualın təkrarlanmadığını yoxla
            if (!questionsForCurrentPlayer.some(q => q.question === questionCandidate.question)) {
                questionsForCurrentPlayer.push(questionCandidate);
                globallyUsedQuestions.add(questionCandidate.question); // Qlobal istifadəyə əlavə et (hətta təkrarlansa da)
                selectedCount++;
            }
            attempts++;
        }

        if (questionsForCurrentPlayer.length < QUESTIONS_PER_PLAYER) {
            alert(`Oyunçu üçün ${QUESTIONS_PER_PLAYER} unikal sual seçilə bilmədi. Mövcud sual sayı: ${questionsForCurrentPlayer.length}. Sual hovuzunu yoxlayın və ya daha çox sual əlavə edin.`);
            showScreen('initial-setup');
            return false;
        }
        questionsForCurrentPlayer = shuffleArray(questionsForCurrentPlayer); // Seçilmiş sualları da qarışdır
        return true;
    }


    function createLetterButtons() {
        letterButtonsContainer.innerHTML = '';
        // Lüğətdə sözü olan hərfləri götürürük
        const availableLetters = Object.keys(sampleVocabulary).filter(letter => sampleVocabulary[letter] && sampleVocabulary[letter].length > 0 && !(sampleVocabulary[letter].length === 1 && sampleVocabulary[letter][0].includes("çətin")));
        
        availableLetters.forEach(letter => {
            const button = document.createElement('button');
            button.textContent = letter;
            button.addEventListener('click', () => selectLetterForPlayer(letter));
            letterButtonsContainer.appendChild(button);
        });
         if (availableLetters.length === 0) {
            letterButtonsContainer.innerHTML = "<p style='color: var(--danger-color);'>Lüğətdə heç bir hərf üçün söz tapılmadı. Oyunu davam etmək mümkün deyil.</p>";
        }
    }

    function selectLetterForPlayer(letter) {
        selectedLetter = letter.toUpperCase();
        chosenLetterDisplay.textContent = selectedLetter;
        exampleLetterPlaceholder.textContent = selectedLetter;
        reminderLetterAdmin.textContent = selectedLetter;
        startPlayerGameSession();
    }

    function startPlayerGameSession() {
        score = 0;
        questionsAskedThisPlayerGame = 0; // Hər yeni sessiyada sıfırla
        
        scoreDisplay.textContent = score;
        feedbackMessage.textContent = '';
        feedbackMessage.className = '';
        clearTimeout(feedbackTimeoutId);
        clearTimeout(answerTimerId);
        
        enableAdminDecisionButtons();
        showScreen('game');
        displayNextQuestionForPlayer();
    }

    function displayNextQuestionForPlayer() {
        clearTimeout(feedbackTimeoutId);
        clearTimeout(answerTimerId);

        // questionsForCurrentPlayer-in boş olub olmadığını və ya indeksin həddi aşmadığını yoxla
        if (questionsAskedThisPlayerGame >= QUESTIONS_PER_PLAYER || questionsAskedThisPlayerGame >= questionsForCurrentPlayer.length) {
            endPlayerGame();
            return;
        }

        currentQuestion = questionsForCurrentPlayer[questionsAskedThisPlayerGame];
        // questionsAskedThisPlayerGame artıq adminGivesFeedback-də və ya handleTimeout-da artırılacaq
        // Burada yalnız göstərmək üçün istifadə edirik
        questionCountDisplay.textContent = questionsAskedThisPlayerGame + 1; // Növbəti sual nömrəsi

        categoryDisplay.textContent = currentQuestion.category;
        questionText.textContent = currentQuestion.question;

        feedbackMessage.textContent = `${currentPlayerName} cavabını düşünür...`;
        feedbackMessage.className = 'feedback-info';
        exampleAnswersArea.classList.add('hidden');
        noExamplesMessage.classList.add('hidden');
        generateAndDisplayExampleAnswers();
        enableAdminDecisionButtons();
        startAnswerTimer();
    }

    function startAnswerTimer() {
        timeLeftForAnswer = adminSetAnswerTimeLimit;
        timerDisplay.textContent = timeLeftForAnswer;
        answerTimerId = setInterval(() => {
            timeLeftForAnswer--;
            timerDisplay.textContent = timeLeftForAnswer;
            if (timeLeftForAnswer <= 0) {
                clearInterval(answerTimerId);
                handleTimeout();
            }
        }, 1000);
    }

    function handleTimeout() {
        showFeedback("Vaxt bitdi! Cavab səhv qəbul edildi.", "incorrect");
        disableAdminDecisionButtons();
        adminGivesFeedback(false, true); // Timeout səbəbi ilə səhv cavab
    }

    function generateAndDisplayExampleAnswers() {
        exampleAnswersList.innerHTML = '';
        const letterSpecificExamples = [];
        const wordsStartingWithLetter = sampleVocabulary[selectedLetter] || [];

        if (wordsStartingWithLetter.length > 0) {
            const shuffledWords = shuffleArray([...wordsStartingWithLetter]);
            for (let i = 0; i < Math.min(5, shuffledWords.length); i++) {
                if (shuffledWords[i] && !shuffledWords[i].includes("çətin")) { // "Ğ" kimi problemli nümunələri burax
                    letterSpecificExamples.push(capitalizeFirstLetter(shuffledWords[i]));
                }
            }
        }

        if (letterSpecificExamples.length > 0) {
            letterSpecificExamples.forEach(ex => {
                const li = document.createElement('li');
                li.textContent = ex;
                exampleAnswersList.appendChild(li);
            });
            toggleExamplesBtn.disabled = false;
            noExamplesMessage.classList.add('hidden');
        } else {
            noExamplesMessage.classList.remove('hidden');
            toggleExamplesBtn.disabled = true;
            exampleAnswersArea.classList.add('hidden');
        }
    }
    
    function capitalizeFirstLetter(string) {
        if (!string) return '';
        return string.charAt(0).toUpperCase() + string.slice(1);
    }

    function adminGivesFeedback(isCorrect, fromTimeout = false) {
        if (!fromTimeout) {
            clearTimeout(answerTimerId);
        }

        if (isCorrect) {
            score++;
            scoreDisplay.textContent = score;
            if (!fromTimeout) showFeedback("Əla! Düzgün cavab!", "correct");
        } else {
            if (!fromTimeout) showFeedback("Təəssüf... Bu dəfə alınmadı.", "incorrect");
        }
        disableAdminDecisionButtons();
        questionsAskedThisPlayerGame++; // Sual sayını burada artırırıq

        feedbackTimeoutId = setTimeout(() => {
            // Növbəti suala keçməzdən əvvəl yenidən yoxlayaq
            if (questionsAskedThisPlayerGame < QUESTIONS_PER_PLAYER && questionsAskedThisPlayerGame < questionsForCurrentPlayer.length) {
                displayNextQuestionForPlayer();
            } else {
                endPlayerGame();
            }
        }, fromTimeout ? 500 : FEEDBACK_DISPLAY_TIME);
    }

    function endPlayerGame(forceEnd = false) {
        clearTimeout(feedbackTimeoutId);
        clearTimeout(answerTimerId);
        savePlayerResult(currentPlayerName, score);
        
        playerNameGameOver.textContent = currentPlayerName;
        finalPlayerScoreDisplay.textContent = score;
        showScreen('player-game-over');
        if (forceEnd) {
            showFeedback(`${currentPlayerName} üçün oyun admin tərəfindən bitirildi. Yekun xal: ${score}`, "info", true);
        }
    }

    function savePlayerResult(name, playerScore) {
        let leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || [];
        const existingPlayerIndex = leaderboard.findIndex(p => p.name.toLowerCase() === name.toLowerCase());
        if (existingPlayerIndex > -1) {
            if (playerScore > leaderboard[existingPlayerIndex].score) {
                 leaderboard[existingPlayerIndex].score = playerScore;
            }
        } else {
            leaderboard.push({ name: name, score: playerScore });
        }
        leaderboard.sort((a, b) => b.score - a.score);
        localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(leaderboard));
    }

    function displayLeaderboard() {
        leaderboardTableBody.innerHTML = '';
        let leaderboard = JSON.parse(localStorage.getItem(LEADERBOARD_KEY)) || [];
        if (leaderboard.length === 0) {
            const row = leaderboardTableBody.insertRow();
            const cell = row.insertCell();
            cell.colSpan = 3;
            cell.textContent = "Hələ heç bir nəticə yoxdur.";
            cell.style.textAlign = "center";
            return;
        }
        leaderboard.forEach((player, index) => {
            const row = leaderboardTableBody.insertRow();
            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = player.name;
            row.insertCell().textContent = player.score;
        });
    }
    
    function clearLeaderboard() {
         if (confirm("Liderlər cədvəlini təmizləməyə əminsinizmi?")) {
            localStorage.removeItem(LEADERBOARD_KEY);
            displayLeaderboard();
            showFeedback("Liderlər cədvəli təmizləndi.", "info", true);
        }
    }

    function showFeedback(message, type, persist = false) {
        feedbackMessage.textContent = message;
        feedbackMessage.className = `feedback-${type}`;
        if (!persist && type !== 'info') { // İnfo mesajları qalsın, digərləri silinsin (əgər lazım olarsa)
            // setTimeout(() => { if (feedbackMessage.className.includes(type)) feedbackMessage.textContent = ''; }, FEEDBACK_DISPLAY_TIME + 500);
        }
    }

    function enableAdminDecisionButtons() {
        adminCorrectBtn.disabled = false;
        adminIncorrectBtn.disabled = false;
        adminEndPlayerGameBtn.disabled = false;
    }

    function disableAdminDecisionButtons() {
        adminCorrectBtn.disabled = true;
        adminIncorrectBtn.disabled = true;
        // adminEndPlayerGameBtn aktiv qalsın
    }

    function shuffleArray(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [
                array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    adminCorrectBtn.addEventListener('click', () => adminGivesFeedback(true));
    adminIncorrectBtn.addEventListener('click', () => adminGivesFeedback(false));
    adminEndPlayerGameBtn.addEventListener('click', () => endPlayerGame(true));
    toggleExamplesBtn.addEventListener('click', () => {
        exampleAnswersArea.classList.toggle('hidden');
        toggleExamplesBtn.innerHTML = exampleAnswersArea.classList.contains('hidden') ?
            '<i class="fas fa-lightbulb"></i> Nümunə Cavabları Göstər' :
            '<i class="fas fa-eye-slash"></i> Nümunə Cavabları Gizlət';
    });
    nextPlayerBtn.addEventListener('click', () => {
        showScreen('initial-setup');
    });
    showLeaderboardBtn.addEventListener('click', () => {
        showScreen('leaderboard');
    });
    backToPlayerNameBtn.addEventListener('click', () => {
        showScreen('initial-setup');
    });
    clearLeaderboardBtn.addEventListener('click', clearLeaderboard);

    initGameSetup();
});
